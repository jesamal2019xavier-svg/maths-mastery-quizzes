<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binomial Expansion Mastery Quiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
            font-size: 18px;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 35px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 15px;
            font-size: 2.5rem;
        }
        
        .subtitle {
            text-align: center;
            color: #5d6d7e;
            margin-bottom: 25px;
            font-size: 1.2rem;
        }
        
        .name-input-section {
            background: #e8f4fc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
            border-left: 5px solid #3498db;
        }
        
        .name-input {
            font-size: 1.1rem;
            padding: 12px 20px;
            width: 300px;
            border: 2px solid #3498db;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .question {
            background: #f8f9fa;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #3498db;
            border-radius: 8px;
            font-size: 1.1rem;
        }
        
        .question-number {
            background: #3498db;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .question-text {
            margin: 15px 0;
            line-height: 1.8;
            font-size: 1.2rem;
        }
        
        .math-display {
            font-family: 'Cambria Math', 'Times New Roman', serif;
            font-size: 1.3rem;
        }
        
        .answer-row {
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 700px;
            margin: 15px 0;
        }
        
        .answer-input {
            flex: 1;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1.1rem;
            font-family: monospace;
            min-width: 300px;
        }
        
        .preview-box {
            flex: 1;
            min-height: 52px;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            background: #f9f9f9;
            font-size: 1.3rem;
            font-family: 'Cambria Math', 'Times New Roman', serif;
            color: #333;
            display: flex;
            align-items: center;
            min-width: 300px;
            overflow-x: auto;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preview-box:hover {
            background: #f0f0f0;
            border-color: #3498db;
        }
        
        .preview-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        button {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 14px 35px;
            margin: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }
        
        .btn-reset {
            background: #e74c3c;
        }
        
        .btn-reset:hover {
            background: #c0392b;
        }
        
        .feedback {
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            display: none;
            font-size: 1.1rem;
        }
        
        .correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .result {
            margin: 25px 0;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2rem;
        }
        
        .score {
            font-size: 2rem;
            font-weight: bold;
            margin: 15px 0;
            color: #2c3e50;
        }
        
        .certificate {
            display: none;
            background: white;
            border: 15px solid #f1c40f;
            padding: 50px;
            margin: 40px auto;
            max-width: 700px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        
        .certificate h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 2.2rem;
        }
        
        .student-name {
            font-size: 2.5rem;
            color: #3498db;
            margin: 25px 0;
            padding: 20px;
            border-bottom: 4px solid #f1c40f;
            display: inline-block;
        }
        
        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 6px solid #3498db;
            font-size: 1.1rem;
        }
        
        .center {
            text-align: center;
        }
        
        .click-hint {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .superscript {
            font-size: 0.85em;
            vertical-align: super;
            line-height: 0;
        }
        
        /* Stacked fraction styling */
        .stacked-fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 2px;
            line-height: 1;
        }
        
        .fraction-numerator {
            display: block;
            border-bottom: 1px solid #333;
            padding: 0 4px;
            line-height: 1.1;
            min-height: 1.2em;
        }
        
        .fraction-denominator {
            display: block;
            padding: 0 4px;
            line-height: 1.1;
            min-height: 1.2em;
        }
        
        /* Special styling for answer input fractions */
        .fraction-input {
            display: inline-block;
            text-align: center;
            margin: 0 2px;
            vertical-align: middle;
        }
        
        .frac-num-input, .frac-den-input {
            width: 40px;
            text-align: center;
            padding: 2px;
            border: 1px solid #ccc;
            border-radius: 2px;
            font-size: 0.9em;
        }
        
        .frac-num-input {
            border-bottom: none;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .frac-den-input {
            border-top: 1px solid #ccc;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        
        .fraction-separator {
            margin: 0 8px;
            color: #666;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Binomial Expansion Mastery Quiz</h1>
        <p class="subtitle">AS Edexcel Mathematics - Score 100% for Certificate</p>
        
        <div class="name-input-section" id="nameSection">
            <strong>üéì Enter Your Name:</strong><br>
            <input type="text" id="studentNameInput" class="name-input" placeholder="Enter your full name">
            <br><br>
            <button onclick="startQuiz()">Start Quiz</button>
        </div>
        
        <div class="instructions" id="quizInstructions" style="display: none;">
            <strong>üéØ Instructions:</strong>
            <ul>
                <li>Answer all 10 questions</li>
                <li>For fractions: Use <strong>numerator/denominator</strong> format (e.g., 3/4 for ¬æ)</li>
                <li>For multiple values, separate with comma (e.g., 2, 3)</li>
                <li>Use ^ for powers (e.g., x^2 for x¬≤)</li>
                <li><strong>Click the preview box</strong> to copy formatted answer back</li>
                <li>Spaces don't matter - they're ignored</li>
                <li><strong>Note:</strong> You cannot change answers after checking!</li>
                <li>100% score required for certificate</li>
            </ul>
        </div>
        
        <div id="quizContainer" style="display: none;">
            <!-- Questions will appear here -->
        </div>
        
        <div class="center" id="buttonSection" style="display: none;">
            <button onclick="checkAllAnswers()" id="checkButton">Check All Answers</button>
            <button class="btn-reset" onclick="resetQuiz()">New Quiz</button>
        </div>
        
        <div id="resultArea"></div>
        
        <div class="certificate" id="certificate">
            <h2>üéì Certificate of Mastery</h2>
            <p>This certifies that</p>
            <div class="student-name" id="certificateName">[Your Name]</div>
            <p>has successfully mastered Binomial Expansion</p>
            <p>with a perfect score of 10/10</p>
            <p><strong>Date:</strong> <span id="certificateDate"></span></p>
            <br>
            <button onclick="printCertificate()">Print Certificate</button>
            <button class="btn-reset" onclick="hideCertificate()">Close</button>
        </div>
    </div>

    <script>
        // ========== SIMPLE UTILITY FUNCTIONS ==========
        function nCr(n, r) {
            if (r < 0 || r > n) return 0;
            if (r === 0 || r === n) return 1;
            r = Math.min(r, n - r);
            let result = 1;
            for (let i = 1; i <= r; i++) {
                result = result * (n - i + 1) / i;
            }
            return Math.round(result);
        }
        
        function gcd(a, b) {
            a = Math.abs(a);
            b = Math.abs(b);
            while (b) {
                [a, b] = [b, a % b];
            }
            return a;
        }
        
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        // ========== ENHANCED SUPERSCRIPT CONVERSION WITH FRACTIONS ==========
        function convertToSuperscript(text) {
            if (!text) return '';
            
            let result = text;
            
            // Convert fractions like 3/4 to stacked fractions
            result = result.replace(/(-?\d+)\/(-?\d+)/g, function(match, num, den) {
                return `<span class="stacked-fraction">
                    <span class="fraction-numerator">${num}</span>
                    <span class="fraction-denominator">${den}</span>
                </span>`;
            });
            
            // Convert powers
            result = result.replace(/([a-zA-Z0-9\)])\^(\d+)/g, function(match, before, num) {
                const superscriptDigits = {'0':'‚Å∞','1':'¬π','2':'¬≤','3':'¬≥','4':'‚Å¥','5':'‚Åµ','6':'‚Å∂','7':'‚Å∑','8':'‚Å∏','9':'‚Åπ'};
                const superscript = num.split('').map(d => superscriptDigits[d] || d).join('');
                return before + '<span class="superscript">' + superscript + '</span>';
            });
            
            // Convert a=..., b=..., c=... format
            result = result.replace(/a=(-?\d+),b=(-?\d+),c=(-?\d+)/g, function(match, a, b, c) {
                return `a=${a}, b=${b}, c=${c}`;
            });
            
            return result;
        }
        
        function convertFromSuperscript(html) {
            if (!html) return '';
            
            let text = html;
            
            // Convert stacked fractions back to a/b format
            text = text.replace(/<span class="stacked-fraction">.*?<span class="fraction-numerator">(-?\d+)<\/span>.*?<span class="fraction-denominator">(-?\d+)<\/span>.*?<\/span>/g, function(match, num, den) {
                return `${num}/${den}`;
            });
            
            // Convert superscript back to ^ notation
            text = text.replace(/<span class="superscript">([‚Å∞¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ]+)<\/span>/g, function(match, sup) {
                const normalDigits = {'‚Å∞':'0','¬π':'1','¬≤':'2','¬≥':'3','‚Å¥':'4','‚Åµ':'5','‚Å∂':'6','‚Å∑':'7','‚Å∏':'8','‚Åπ':'9'};
                const num = sup.split('').map(d => normalDigits[d] || d).join('');
                return '^' + num;
            });
            
            // Remove any remaining HTML tags
            text = text.replace(/<[^>]*>/g, '');
            
            // Remove extra spaces in a=...,b=...,c=... format
            text = text.replace(/a\s*=\s*(-?\d+)\s*,\s*b\s*=\s*(-?\d+)\s*,\s*c\s*=\s*(-?\d+)/g, 'a=$1,b=$2,c=$3');
            
            return text;
        }
        
        // ========== STACKED FRACTION HELPER ==========
        function createStackedFraction(numerator, denominator) {
            return `<span class="stacked-fraction">
                <span class="fraction-numerator">${numerator}</span>
                <span class="fraction-denominator">${denominator}</span>
            </span>`;
        }
        
        function createFractionTimesX(numerator, denominator) {
            return `<span class="fraction-with-x">
                ${createStackedFraction(numerator, denominator)}
                <span style="margin-left: 3px;">x</span>
            </span>`;
        }
        
        // ========== FRACTION SIMPLIFICATION ==========
        function simplifyFraction(numerator, denominator) {
            if (denominator === 0) return {numerator: 0, denominator: 1};
            if (numerator === 0) return {numerator: 0, denominator: 1};
            
            const g = gcd(numerator, denominator);
            const sign = (numerator * denominator < 0) ? -1 : 1;
            
            return {
                numerator: sign * Math.abs(numerator) / g,
                denominator: Math.abs(denominator) / g
            };
        }
        
        function formatFraction(numerator, denominator) {
            const simplified = simplifyFraction(numerator, denominator);
            if (simplified.denominator === 1) {
                return simplified.numerator.toString();
            }
            return `${simplified.numerator}/${simplified.denominator}`;
        }
        
        // ========== SETUP PREVIEW WITH WORKING COPY-BACK ==========
        function setupSuperscriptPreview(inputId) {
            const input = document.getElementById(inputId);
            const previewId = inputId + '-preview';
            const preview = document.getElementById(previewId);
            
            if (!preview) return;
            
            function updatePreview() {
                preview.innerHTML = convertToSuperscript(input.value);
            }
            
            input.addEventListener('input', updatePreview);
            input.addEventListener('keyup', updatePreview);
            
            preview.addEventListener('click', function() {
                const htmlContent = this.innerHTML;
                const textContent = convertFromSuperscript(htmlContent);
                input.value = textContent;
                input.focus();
                
                this.style.background = '#e8f4fc';
                this.style.borderColor = '#3498db';
                setTimeout(() => {
                    this.style.background = '#f9f9f9';
                    this.style.borderColor = '#e0e0e0';
                }, 300);
                
                input.dispatchEvent(new Event('input'));
            });
            
            updatePreview();
        }
        
        // ========== QUIZ STATE ==========
        let currentQuiz = [];
        let studentName = "";
        let answersChecked = false;
        
        // ========== QUESTION GENERATORS ==========
        
        function generateQ1() {
            const a = getRandomInt(1, 6);
            let b;
            do {
                b = getRandomInt(-6, 6);
            } while (Math.abs(b) <= 1 || b === 0 || Math.abs(b) === a);
            
            const n = getRandomInt(3, 5);
            
            let answer = "";
            for (let r = 0; r <= n; r++) {
                const coeff = nCr(n, r) * Math.pow(a, n - r) * Math.pow(b, r);
                if (coeff !== 0) {
                    if (answer && coeff > 0) answer += "+";
                    if (coeff < 0) answer += "-";
                    const absCoeff = Math.abs(coeff);
                    if (absCoeff !== 1 || (n - r === 0 && r === 0)) answer += absCoeff;
                    if (n - r > 0) {
                        answer += "x";
                        if (n - r > 1) answer += "^" + (n - r);
                    }
                    if (r > 0) {
                        answer += "y";
                        if (r > 1) answer += "^" + r;
                    }
                }
            }
            
            const bDisplay = b < 0 ? `- ${Math.abs(b)}` : `+ ${b}`;
            const aDisplay = a === 1 ? "" : a;
            
            return {
                question: `Expand (${aDisplay}x ${bDisplay}y)<sup>${n}</sup>`,
                answer: answer.replace(/\b1([a-zA-Z])/g, '$1').replace(/\b-1([a-zA-Z])/g, '-$1'),
                hint: "Format: 8x^3+36x^2y+54xy^2+27y^3"
            };
        }
        
        function generateQ2() {
            const a = getRandomInt(1, 6);
            const b = getRandomInt(2, 7);
            const n = getRandomInt(3, 6);
            const k = getRandomInt(2, n - 1);
            
            const numerator = nCr(n, k) * Math.pow(a, n - k);
            const denominator = Math.pow(b, k);
            
            const answer = formatFraction(numerator, denominator);
            
            const displayFraction = b === 1 ? "x" : createStackedFraction("x", b);
            
            return {
                question: `Find the coefficient of x<sup>${k}</sup> in the expansion of (${a} + ${displayFraction})<sup>${n}</sup>`,
                answer: answer,
                hint: "Answer as fraction a/b (e.g., 3/4)"
            };
        }
        
        function generateQ3() {
            let a = getRandomInt(2, 5);
            let b = getRandomInt(2, 5);
            while (a === b) b = getRandomInt(2, 5);
            const n = getRandomInt(3, 5);
            
            let terms = [];
            for (let r = 0; r <= n; r++) {
                terms[r] = nCr(n, r) * Math.pow(b, r);
            }
            
            let result = [];
            for (let i = 0; i <= n + 1; i++) result[i] = 0;
            
            for (let r = 0; r <= n; r++) {
                result[r] += terms[r];
                if (r + 1 <= n + 1) {
                    result[r + 1] += terms[r] * a;
                }
            }
            
            let answer = "";
            for (let i = 0; i < result.length; i++) {
                if (result[i] !== 0) {
                    if (answer && result[i] > 0) answer += "+";
                    if (result[i] < 0) answer += "-";
                    const absCoeff = Math.abs(result[i]);
                    if (absCoeff !== 1 || i === 0) answer += absCoeff;
                    if (i > 0) {
                        answer += "x";
                        if (i > 1) answer += `^${i}`;
                    }
                }
            }
            
            const aDisplay = a === 1 ? "" : a;
            const bDisplay = b === 1 ? "" : b;
            
            return {
                question: `Expand (1 + ${aDisplay}x)(1 + ${bDisplay}x)<sup>${n}</sup>`,
                answer: answer.replace(/\b1([a-zA-Z])/g, '$1').replace(/\b-1([a-zA-Z])/g, '-$1'),
                hint: "Format: 1+5x+10x^2+10x^3+5x^4+x^5"
            };
        }
        
        function generateQ4() {
            const b = getRandomInt(1, 6);
            let a = getRandomInt(1, 6);
            while (a === b) a = getRandomInt(1, 6);
            
            const n = getRandomInt(3, 5);
            const k = getRandomInt(2, n - 1);
            
            const coefficient = nCr(n, k) * Math.pow(b, n - k) * Math.pow(a, k);
            
            let expression;
            if (b === 1 && k === n) {
                expression = `(ax)<sup>${n}</sup>`;
            } else if (b === 1) {
                expression = `(1 + ax)<sup>${n}</sup>`;
            } else {
                expression = `(${b} + ax)<sup>${n}</sup>`;
            }
            
            return {
                question: `The coefficient of x<sup>${k}</sup> in the expansion of ${expression} is ${coefficient}. Find the positive value of a.`,
                answer: a.toString(),
                hint: "Answer as integer"
            };
        }
        
        function generateQ5() {
            const a = getRandomInt(1, 6);
            const d = getRandomInt(1, 6);
            const c = getRandomInt(1, 6);
            const n = getRandomInt(3, 5);
            
            const b1Num = getRandomInt(1, 4);
            const b1Den = getRandomInt(2, 5);
            
            // Simplify initial b1 fraction
            const b1Simplified = simplifyFraction(b1Num, b1Den);
            const b1 = b1Simplified.numerator / b1Simplified.denominator;
            
            const A = a * nCr(n, 2) * Math.pow(c, n - 2);
            const B = -d * nCr(n, 1) * Math.pow(c, n - 1);
            
            const p = A * b1 * b1 + B * b1;
            
            // Solve quadratic: A*b¬≤ + B*b - p = 0
            // b2 = (-B - A*b1) / A (since sum of roots = -B/A)
            const b2 = (-B - A * b1) / A;
            
            // Format b1 as fraction if not integer
            let b1Formatted;
            if (b1Simplified.denominator === 1) {
                b1Formatted = b1Simplified.numerator.toString();
            } else {
                b1Formatted = `${b1Simplified.numerator}/${b1Simplified.denominator}`;
            }
            
            // Format b2 as fraction
            const b2Simplified = simplifyFraction(Math.round(b2 * 1000), 1000);
            let b2Formatted;
            if (Math.abs(b2 - Math.round(b2)) < 0.001) {
                b2Formatted = Math.round(b2).toString();
            } else if (b2Simplified.denominator === 1) {
                b2Formatted = b2Simplified.numerator.toString();
            } else {
                b2Formatted = `${b2Simplified.numerator}/${b2Simplified.denominator}`;
            }
            
            const aDisplay = a === 1 ? "" : a;
            const dDisplay = d === 1 ? "" : d;
            const cDisplay = c === 1 ? "" : c;
            
            return {
                question: `The coefficient of x<sup>2</sup> in the expansion of (${aDisplay} - ${dDisplay}x)(${cDisplay} + bx)<sup>${n}</sup> is ${Math.round(p)}. Find the possible values of b.`,
                answer: `${b1Formatted},${b2Formatted}`,
                hint: "Enter both fractions separated by comma (e.g., 1/2, -3/4)"
            };
        }
        
        function generateQ6() {
            // FIXED: Based on specification: (a - 1/b x)^n where 0 < a, b < 7, n ‚àà [3,4,5]
            const a = getRandomInt(1, 6);  // 1 to 6 inclusive (0 < a < 7)
            const b = getRandomInt(1, 6);  // 1 to 6 inclusive (0 < b < 7)
            const n = [3, 4, 5][getRandomInt(0, 2)];  // n ‚àà {3,4,5}
            
            // Calculate terms using the formula: a^n - (n*a^(n-1)/b)x + (n(n-1)a^(n-2)/(2b^2))x^2 - (n(n-1)(n-2)a^(n-3)/(6b^3))x^3
            const term0 = Math.pow(a, n);
            
            // First term: -(n*a^(n-1))/b
            const term1Num = -n * Math.pow(a, n - 1);
            const term1Den = b;
            
            // Second term: n(n-1)a^(n-2)/(2b^2)
            const term2Num = n * (n - 1) * Math.pow(a, n - 2);
            const term2Den = 2 * Math.pow(b, 2);
            
            // Third term: -n(n-1)(n-2)a^(n-3)/(6b^3)
            const term3Num = -n * (n - 1) * (n - 2) * Math.pow(a, n - 3);
            const term3Den = 6 * Math.pow(b, 3);
            
            // Simplify all fractions
            const term1 = simplifyFraction(term1Num, term1Den);
            const term2 = simplifyFraction(term2Num, term2Den);
            const term3 = simplifyFraction(term3Num, term3Den);
            
            // Build answer string with proper formatting
            let answer = term0.toString();
            
            // Add term1
            if (term1.numerator >= 0) answer += "+";
            if (term1.denominator === 1) {
                answer += `${term1.numerator}x`;
            } else {
                answer += `${term1.numerator}/${term1.denominator}x`;
            }
            
            // Add term2
            if (term2.numerator >= 0) answer += "+";
            if (term2.denominator === 1) {
                answer += `${term2.numerator}x^2`;
            } else {
                answer += `${term2.numerator}/${term2.denominator}x^2`;
            }
            
            // Add term3
            if (term3.numerator >= 0) answer += "+";
            if (term3.denominator === 1) {
                answer += `${term3.numerator}x^3`;
            } else {
                answer += `${term3.numerator}/${term3.denominator}x^3`;
            }
            
            // Remove any ++ or +- patterns
            answer = answer.replace(/\+\-/g, "-").replace(/\+\+/g, "+");
            
            // Create display fraction (1/b)
            const displayFraction = b === 1 ? "x" : createFractionTimesX("1", b);
            
            return {
                question: `Find the first four terms in the expansion of (${a} - ${displayFraction})<sup>${n}</sup>`,
                answer: answer.replace(/\s+/g, ''),
                hint: "Format: 64-48/5x+12/25x^2-1/125x^3 (use fractions, not decimals)"
            };
        }
        
        function generateQ7() {
            const a = getRandomInt(1, 7);
            const b = getRandomInt(1, 7);
            const n = getRandomInt(3, 4);
            
            let answerTerms = [];
            
            for (let r = 0; r <= n; r++) {
                const coeff = nCr(n, r) * Math.pow(a, n - r) * Math.pow(b, r);
                const power = n - 2 * r;
                
                if (coeff !== 0) {
                    let term = "";
                    
                    if (coeff !== 1 || power === 0) {
                        term += coeff;
                    } else if (coeff === -1) {
                        term += "-";
                    }
                    
                    if (power > 0) {
                        if (term === "-") {
                            term += "x";
                        } else if (term === "" && coeff === 1) {
                            term = "x";
                        } else if (term === "" && coeff === -1) {
                            term = "-x";
                        } else {
                            term += "x";
                        }
                        
                        if (power > 1) {
                            term += `^${power}`;
                        }
                    } else if (power < 0) {
                        const absPower = Math.abs(power);
                        term += `/x`;
                        if (absPower > 1) {
                            term += `^${absPower}`;
                        }
                    }
                    
                    answerTerms.push({ coeff, term });
                }
            }
            
            let answer = "";
            for (let i = 0; i < answerTerms.length; i++) {
                const { coeff, term } = answerTerms[i];
                if (i > 0 && coeff > 0) {
                    answer += "+";
                }
                answer += term;
            }
            
            const aDisplay = a === 1 ? "" : a;
            const bDisplay = b === 1 ? "" : b;
            
            const secondTerm = b === 1 ? "x" : createStackedFraction(bDisplay, "x");
            
            return {
                question: `Find the binomial expansion of (${aDisplay}x + ${secondTerm})<sup>${n}</sup>`,
                answer: answer.replace(/\b1([a-zA-Z])/g, '$1').replace(/\b-1([a-zA-Z])/g, '-$1'),
                hint: `For n=3: a^3x^3+3a^2b x+3ab^2/x+b^3/x^3<br>For n=4: a^4x^4+4a^3b x^2+6a^2b^2+4ab^3/x^2+b^4/x^4`
            };
        }
        
        function generateQ8() {
            const a = getRandomInt(1, 7);
            const b = getRandomInt(1, 7);
            const n = getRandomInt(2, 5);
            const power = 2 * n;
            
            const r = n;
            const coeff = nCr(power, r) * Math.pow(a, power - r) * Math.pow(b, r);
            
            const aDisplay = a === 1 ? "" : a;
            const bDisplay = b === 1 ? "" : b;
            
            const secondTerm = b === 1 ? "x" : createStackedFraction(bDisplay, "x");
            
            return {
                question: `Find the term independent of x in the expansion of (${aDisplay}x + ${secondTerm})<sup>${power}</sup>`,
                answer: coeff.toString(),
                hint: "Answer as integer"
            };
        }
        
        function generateQ9() {
            // FIXED: Ensure p and q are between 1 and 7 (exclusive)
            const p = getRandomInt(2, 6); // 2 to 6 (since 1 < p < 7)
            const q = getRandomInt(2, 6); // 2 to 6 (since 1 < q < 7)
            const n = getRandomInt(2, 5);
            
            // Expand (p - x)(q + x)^n
            const a = p * Math.pow(q, n);
            const b = p * n * Math.pow(q, n - 1) - Math.pow(q, n);
            const c = p * nCr(n, 2) * Math.pow(q, n - 2) - n * Math.pow(q, n - 1);
            
            return {
                question: `If x is so small that terms of x<sup>3</sup> and higher can be ignored and (${p} - x)(${q} + x)<sup>${n}</sup> = a + bx + cx<sup>2</sup>. Find a, b, c.`,
                answer: `a=${a},b=${b},c=${c}`,
                hint: "Format: a=8,b=4,c=1 (no spaces)"
            };
        }
        
        function generateQ10() {
            // FIXED: Based on specification: (ax + b/x¬≤)^(3n) where 1 < a, b < 6, n ‚àà {2,3,4,5}
            const a = getRandomInt(2, 5);  // 2 to 5 (since 1 < a < 6)
            const b = getRandomInt(2, 5);  // 2 to 5 (since 1 < b < 6)
            const n = [2, 3, 4, 5][getRandomInt(0, 3)];  // n ‚àà {2,3,4,5}
            const power = 3 * n;
            
            // Term independent of x occurs when power of x is 0
            // General term: C(3n, r) * (ax)^(3n-r) * (b/x¬≤)^r
            // Power of x: (3n - r) - 2r = 3n - 3r
            // Set equal to 0: 3n - 3r = 0 => r = n
            const r = n;
            const coeff = nCr(power, r) * Math.pow(a, power - r) * Math.pow(b, r);
            
            return {
                question: `Find the term independent of x in the expansion of (${a}x + ${createStackedFraction(b, "x<sup>2</sup>")})<sup>${power}</sup>`,
                answer: coeff.toString(),
                hint: "Answer as integer"
            };
        }
        
        // ========== QUIZ MANAGEMENT ==========
        
        function startQuiz() {
            studentName = document.getElementById('studentNameInput').value.trim();
            if (!studentName) {
                alert("Please enter your name to start the quiz.");
                return;
            }
            
            document.getElementById('nameSection').style.display = 'none';
            document.getElementById('quizInstructions').style.display = 'block';
            document.getElementById('quizContainer').style.display = 'block';
            document.getElementById('buttonSection').style.display = 'block';
            
            generateNewQuiz();
        }
        
        function generateNewQuiz() {
            answersChecked = false;
            currentQuiz = [
                generateQ1(),
                generateQ2(),
                generateQ3(),
                generateQ4(),
                generateQ5(),
                generateQ6(),
                generateQ7(),
                generateQ8(),
                generateQ9(),
                generateQ10()
            ];
            
            displayQuiz();
            document.getElementById('resultArea').innerHTML = '';
            document.getElementById('certificate').style.display = 'none';
            document.getElementById('checkButton').disabled = false;
            document.getElementById('checkButton').innerText = 'Check All Answers';
        }
        
        function resetQuiz() {
            if (confirm("Are you sure you want to start a new quiz? Your current progress will be lost.")) {
                generateNewQuiz();
            }
        }
        
        function displayQuiz() {
            let html = '';
            
            currentQuiz.forEach((q, index) => {
                html += `
                    <div class="question" id="q${index}">
                        <div class="question-number">Question ${index + 1}</div>
                        <div class="question-text math-display">${q.question}</div>
                        
                        <div class="preview-label">Your answer (click preview to copy back):</div>
                        <div class="answer-row">
                            <input type="text" id="ans${index}" class="answer-input" 
                                   placeholder="${q.hint}" ${answersChecked ? 'disabled' : ''}>
                            <div class="preview-box" id="ans${index}-preview" title="Click to copy formatted answer back to input"></div>
                        </div>
                        <div class="click-hint">Click the right box to copy the formatted answer back</div>
                        
                        <div class="feedback" id="fb${index}"></div>
                    </div>
                `;
            });
            
            document.getElementById('quizContainer').innerHTML = html;
            
            if (!answersChecked) {
                setTimeout(() => {
                    for (let i = 0; i < currentQuiz.length; i++) {
                        setupSuperscriptPreview(`ans${i}`);
                    }
                }, 100);
            }
        }
        
        function checkAllAnswers() {
            if (answersChecked) {
                alert("You have already checked your answers. Start a new quiz to try again.");
                return;
            }
            
            let score = 0;
            let allAnswered = true;
            
            for (let i = 0; i < currentQuiz.length; i++) {
                document.getElementById(`ans${i}`).disabled = true;
            }
            document.getElementById('checkButton').disabled = true;
            document.getElementById('checkButton').innerText = 'Answers Checked';
            answersChecked = true;
            
            for (let i = 0; i < currentQuiz.length; i++) {
                const studentAnswer = document.getElementById(`ans${i}`).value.trim();
                const correctAnswer = currentQuiz[i].answer;
                const feedbackDiv = document.getElementById(`fb${i}`);
                const questionDiv = document.getElementById(`q${i}`);
                
                if (!studentAnswer) {
                    allAnswered = false;
                    continue;
                }
                
                let isCorrect = false;
                
                // Special handling for each question type
                if (i === 4) { // Q5 - two fractions, order doesn't matter
                    const studentVals = studentAnswer.split(',').map(v => v.trim());
                    const correctVals = correctAnswer.split(',').map(v => v.trim());
                    
                    if (studentVals.length === 2 && correctVals.length === 2) {
                        // Parse fractions
                        const parseFraction = (str) => {
                            if (str.includes('/')) {
                                const [num, den] = str.split('/').map(Number);
                                return num / den;
                            }
                            return parseFloat(str);
                        };
                        
                        const studentNum1 = parseFraction(studentVals[0]);
                        const studentNum2 = parseFraction(studentVals[1]);
                        const correctNum1 = parseFraction(correctVals[0]);
                        const correctNum2 = parseFraction(correctVals[1]);
                        
                        // Check both orders
                        if ((Math.abs(studentNum1 - correctNum1) < 0.001 && Math.abs(studentNum2 - correctNum2) < 0.001) ||
                            (Math.abs(studentNum1 - correctNum2) < 0.001 && Math.abs(studentNum2 - correctNum1) < 0.001)) {
                            isCorrect = true;
                        }
                    }
                } else if (i === 8) { // Q9 - a=...,b=...,c=... format
                    const studentParts = studentAnswer.toLowerCase().replace(/\s+/g, '').match(/a=(-?\d+),b=(-?\d+),c=(-?\d+)/);
                    const correctParts = correctAnswer.toLowerCase().replace(/\s+/g, '').match(/a=(-?\d+),b=(-?\d+),c=(-?\d+)/);
                    
                    if (studentParts && correctParts &&
                        studentParts[1] === correctParts[1] &&
                        studentParts[2] === correctParts[2] &&
                        studentParts[3] === correctParts[3]) {
                        isCorrect = true;
                    }
                } else if (i === 5) { // Q6 - special handling for fractions in expansion
                    // Normalize both answers
                    const normalizeAnswer = (ans) => {
                        return ans.replace(/\s+/g, '').toLowerCase()
                            .replace(/\+\-/g, '-')
                            .replace(/\-\-/g, '+')
                            .replace(/\+\+/g, '+');
                    };
                    
                    const normalizedStudent = normalizeAnswer(studentAnswer);
                    const normalizedCorrect = normalizeAnswer(correctAnswer);
                    
                    // Check if they match
                    isCorrect = normalizedStudent === normalizedCorrect;
                    
                    // Also check with simplified fractions
                    if (!isCorrect) {
                        // Try to parse and compare numerically
                        const parseExpression = (expr) => {
                            const terms = expr.split(/(?=[+-])/);
                            const parsed = {};
                            terms.forEach(term => {
                                const match = term.match(/(-?\d*\/?\d*)(x(?:\^\d+)?)?/);
                                if (match) {
                                    const coeff = match[1];
                                    const variable = match[2] || '';
                                    if (coeff && variable !== undefined) {
                                        parsed[variable] = coeff;
                                    }
                                }
                            });
                            return parsed;
                        };
                        
                        const studentParsed = parseExpression(normalizedStudent);
                        const correctParsed = parseExpression(normalizedCorrect);
                        
                        // Compare coefficients for each term
                        const allTerms = new Set([...Object.keys(studentParsed), ...Object.keys(correctParsed)]);
                        let allMatch = true;
                        
                        for (const term of allTerms) {
                            const studentCoeff = studentParsed[term] || '0';
                            const correctCoeff = correctParsed[term] || '0';
                            
                            const parseCoeff = (coeff) => {
                                if (coeff.includes('/')) {
                                    const [num, den] = coeff.split('/').map(Number);
                                    return num / den;
                                }
                                return parseFloat(coeff) || 0;
                            };
                            
                            if (Math.abs(parseCoeff(studentCoeff) - parseCoeff(correctCoeff)) > 0.001) {
                                allMatch = false;
                                break;
                            }
                        }
                        
                        isCorrect = allMatch;
                    }
                } else if (i === 1 || i === 6) { // Questions with simple fractions
                    const parseFraction = (str) => {
                        // Remove spaces and parse
                        const cleanStr = str.replace(/\s+/g, '');
                        if (cleanStr.includes('/')) {
                            const parts = cleanStr.split('/');
                            if (parts.length === 2) {
                                const num = parseFloat(parts[0]);
                                const den = parseFloat(parts[1]);
                                if (den !== 0) return num / den;
                            }
                        }
                        return parseFloat(cleanStr);
                    };
                    
                    const studentNum = parseFraction(studentAnswer);
                    const correctNum = parseFraction(correctAnswer);
                    isCorrect = Math.abs(studentNum - correctNum) < 0.001;
                } else {
                    // For other questions, simple comparison
                    const normalizedStudent = studentAnswer.replace(/\s+/g, '').toLowerCase();
                    const normalizedCorrect = correctAnswer.replace(/\s+/g, '').toLowerCase();
                    isCorrect = normalizedStudent === normalizedCorrect;
                }
                
                if (isCorrect) {
                    score++;
                    feedbackDiv.innerHTML = "<strong>‚úì Correct</strong>";
                    feedbackDiv.className = "feedback correct";
                    questionDiv.style.borderLeftColor = "#28a745";
                } else {
                    feedbackDiv.innerHTML = `<strong>‚úó Incorrect</strong><br>Correct answer: ${convertToSuperscript(correctAnswer)}`;
                    feedbackDiv.className = "feedback incorrect";
                    questionDiv.style.borderLeftColor = "#dc3545";
                }
                
                feedbackDiv.style.display = 'block';
            }
            
            const resultArea = document.getElementById('resultArea');
            if (!allAnswered) {
                resultArea.innerHTML = `
                    <div class="result incorrect">
                        <h3>‚ö†Ô∏è Please answer all questions!</h3>
                        <p>You still have unanswered questions. Complete all before checking.</p>
                    </div>
                `;
                for (let i = 0; i < currentQuiz.length; i++) {
                    document.getElementById(`ans${i}`).disabled = false;
                }
                document.getElementById('checkButton').disabled = false;
                document.getElementById('checkButton').innerText = 'Check All Answers';
                answersChecked = false;
                return;
            }
            
            resultArea.innerHTML = `
                <div class="result ${score === 10 ? 'correct' : 'incorrect'}">
                    <h3>üìä Quiz Results</h3>
                    <div class="score">Score: ${score}/10 (${score * 10}%)</div>
                    <p>${score === 10 ? 'üéâ Perfect score! You\'ve mastered binomial expansion!' : 'Keep practicing! Try again to improve your score.'}</p>
                    ${score < 10 ? '<p><em>Start a new quiz to try again.</em></p>' : ''}
                </div>
            `;
            
            if (score === 10) {
                showCertificate();
            }
            
            resultArea.scrollIntoView({ behavior: 'smooth' });
        }
        
        function showCertificate() {
            const certificate = document.getElementById('certificate');
            const nameSpan = document.getElementById('certificateName');
            const dateSpan = document.getElementById('certificateDate');
            
            nameSpan.textContent = studentName;
            dateSpan.textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            certificate.style.display = 'block';
            certificate.scrollIntoView({ behavior: 'smooth' });
        }
        
        function hideCertificate() {
            document.getElementById('certificate').style.display = 'none';
        }
        
        function printCertificate() {
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Certificate - Binomial Expansion Mastery</title>
                    <style>
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            padding: 60px;
                            text-align: center;
                        }
                        .certificate-print {
                            border: 20px solid #f1c40f;
                            padding: 80px;
                            border-radius: 25px;
                        }
                        h2 { 
                            color: #2c3e50; 
                            font-size: 2.8rem;
                            margin-bottom: 30px;
                        }
                        .student-name {
                            font-size: 3rem;
                            color: #3498db;
                            margin: 40px 0;
                            padding: 30px;
                            border-bottom: 6px solid #f1c40f;
                            display: inline-block;
                        }
                        p {
                            font-size: 1.4rem;
                            margin: 15px 0;
                        }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="certificate-print">
                        <h2>üéì Certificate of Mastery</h2>
                        <p>This certifies that</p>
                        <div class="student-name">${studentName}</div>
                        <p>has successfully mastered Binomial Expansion</p>
                        <p>with a perfect score of 10/10</p>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                        <br><br>
                        <p class="no-print">To print: Press Ctrl+P or select Print from your browser menu.</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }
    </script>
</body>
</html>